package br.ufu.facom.lascam.coverageexploiter.analytics;

import br.ufu.facom.lascam.coverageexploiter.analytics.model.ElementMetric;
import br.ufu.facom.lascam.coverageexploiter.analytics.model.ElementsMetric;
import br.ufu.facom.lascam.coverageexploiter.extractor.ApiExtractor;
import br.ufu.facom.lascam.coverageexploiter.integration.BakerIntegrator;
import br.ufu.facom.lascam.coverageexploiter.posts.model.classifier.Pair;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.StringUtils;

import java.io.IOException;
import java.util.*;

/**
 * Created by Klerisson on 23/10/2014.
 */
public class CoverageMetrics {

    private Map<String, Set<String>> targetApiClassesToMethods;
    private HashSet<String> apiElements;
    private List<Pair> postsPair;
    private ElementsMetric elementsMetric;

    public CoverageMetrics(List<Pair> postsPair, ApiExtractor extractor) {
        this.postsPair = postsPair;
        this.targetApiClassesToMethods = extractor.getClassesToMethodsMap();
        this.apiElements = extractAllElements(this.targetApiClassesToMethods);
        this.elementsMetric = new ElementsMetric();
    }

    public void evaluate() {

        BakerIntegrator baker = new BakerIntegrator();
        for (Pair p : postsPair) {
            String statement = p.getAnswer().getCode();
            Date statementDate = p.getAnswer().getCreationDate();
            if (StringUtils.isNotBlank(statement)) {

                try {
                    baker.parseSnippet(statement);
                    HashSet<String> elements = baker.getAllElements();
                    if (CollectionUtils.isNotEmpty(elements)) {
                        for (String element : elements) {
                            if (isElementOnTheApi(element)) {
                                ElementMetric em = new ElementMetric(element, statementDate);
                                this.elementsMetric.add(em);
                            }
                        }
                    }
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
    }

    private boolean isElementOnTheApi(String element) {
        return this.apiElements.contains(element);
    }

    private HashSet<String> extractAllElements(Map<String, Set<String>> targetApiClassesToMethods) {

        HashSet<String> resultSet = new HashSet<>();
        for (Map.Entry<String, Set<String>> entry : targetApiClassesToMethods.entrySet()) {
            //Class element
            resultSet.add(entry.getKey());
            for (String method : entry.getValue()) {
                //Method
                resultSet.add(entry.getKey() + "." + method);
            }
        }
        return resultSet;
    }
}