package br.ufu.facom.lascam.coverageexploiter.analytics;

import br.ufu.facom.lascam.coverageexploiter.analytics.model.ElementMetric;
import br.ufu.facom.lascam.coverageexploiter.analytics.model.ElementsMetric;

import org.apache.poi.hssf.usermodel.*;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.CreationHelper;

import java.io.FileOutputStream;
import java.io.IOException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Iterator;

/**
 * Created by Fer Madeiral on 24/10/2014.
 */
public class Output {
	
	private static Output INSTANCE;
	
	private String fileName;
	private HSSFWorkbook workbook;
	private HSSFSheet mainSheet, classesSheet, methodsSheet, allMethodsSheet;
	private HSSFCellStyle dataFormatCellStyle;
	
	public static synchronized Output getInstance() {
		if (INSTANCE == null) {
			INSTANCE = new Output();
		}
		return INSTANCE;
	}
	
	private Output() {
		fileName = "Coverage.xls";
		workbook = new HSSFWorkbook();
		mainSheet = workbook.createSheet("All Data");
		classesSheet = workbook.createSheet("Classes");
		methodsSheet = workbook.createSheet("Methods");
		allMethodsSheet = workbook.createSheet("All Methods");
		dataFormatCellStyle = workbook.createCellStyle();
		CreationHelper createHelper = workbook.getCreationHelper();
		dataFormatCellStyle.setDataFormat(createHelper.createDataFormat().getFormat("dd/MM/yyyy"));
	}

	public void writeDataSheet(ElementsMetric<?> elementsMetric) {
		createHeader(mainSheet);
		createHeader(classesSheet);
		createHeader(methodsSheet);
		createHeader(allMethodsSheet);

		int lineMainSheet = 1, lineClassesSheet = 1, lineMethodsSheet = 1, lineAllMethodsSheet = 1;
		Iterator<ElementMetric> ite = elementsMetric.iterator();
		while (ite.hasNext()) {
			ElementMetric elementMetric = ite.next();
			writeRow(mainSheet, lineMainSheet, elementMetric);
			lineMainSheet++;
			if (Character.isUpperCase(elementMetric.getElement().charAt(0)) && elementMetric.getElement().contains(".")) { //className.methodName
				writeRow(methodsSheet, lineMethodsSheet, elementMetric);
				lineMethodsSheet++;
				writeRow(allMethodsSheet, lineAllMethodsSheet, elementMetric);
				lineAllMethodsSheet++;
			} else {
				if (Character.isUpperCase(elementMetric.getElement().charAt(0))) { //className
					writeRow(classesSheet, lineClassesSheet, elementMetric);
					lineClassesSheet++;
				} else { //methodName
					writeRow(allMethodsSheet, lineAllMethodsSheet, elementMetric);
					lineAllMethodsSheet++;
				}
			}
		}
		
		autoSizeColumns(mainSheet);
		autoSizeColumns(classesSheet);
		autoSizeColumns(methodsSheet);
		autoSizeColumns(allMethodsSheet);
		
		FileOutputStream fileOut;
		try {
			fileOut = new FileOutputStream(fileName);
			workbook.write(fileOut);
			fileOut.close();
		} catch (IOException e) {
			e.printStackTrace();
		}
	}
	
	private void createHeader(HSSFSheet sheet) {
		HSSFCellStyle cellStyle = workbook.createCellStyle();
        cellStyle = workbook.createCellStyle();
        HSSFFont hSSFFont = workbook.createFont();
        hSSFFont.setFontName(HSSFFont.FONT_ARIAL);
        hSSFFont.setFontHeightInPoints((short) 10);
        hSSFFont.setBoldweight(HSSFFont.BOLDWEIGHT_BOLD);
        cellStyle.setFont(hSSFFont);
        cellStyle.setAlignment(HSSFCellStyle.ALIGN_CENTER);
		
		HSSFRow row;
		HSSFCell cell;
		
		row = sheet.createRow(0);
		
		cell = row.createCell(0);
		cell.setCellValue("API Element");
		cell.setCellStyle(cellStyle);
		
		cell = row.createCell(1);
		cell.setCellValue("#Citation");
		cell.setCellStyle(cellStyle);

		cell = row.createCell(2);
		cell.setCellValue("Date");
		cell.setCellStyle(cellStyle);
	}
	
	private void writeRow(HSSFSheet sheet, int line, ElementMetric elementMetric) {
		HSSFRow row;
		HSSFCell cell;
		
		row = sheet.createRow(line);
		
		cell = row.createCell(0);
		cell.setCellValue(elementMetric.getElement());
		
		cell = row.createCell(1, HSSFCellStyle.ALIGN_CENTER);
		cell.setCellValue((double) elementMetric.getHitCounter());
		cell.setCellType(Cell.CELL_TYPE_NUMERIC);
		
		String[] separatedDate = elementMetric.getElementPostDate().toString().split("-");
		String dateInString = separatedDate[2] + "/" + separatedDate[1] + "/" + separatedDate[0];
		try {
			cell = row.createCell(2);
			cell.setCellValue(new SimpleDateFormat("dd/MM/yyyy").parse(dateInString));
			cell.setCellStyle(dataFormatCellStyle);
		} catch (ParseException e) {
			e.printStackTrace();
		}
		
		cell = row.createCell(3);
		String formula = "IF(C" + (line + 1) + "<>C" + line + ",COUNTIF(C:C,C" + (line + 1) + ")+D" + line + ",D" + line + ")";
		cell.setCellFormula(formula);
		cell.setCellType(Cell.CELL_TYPE_FORMULA);
	}
	
	private void autoSizeColumns(HSSFSheet sheet) {
		sheet.autoSizeColumn(0);
		sheet.autoSizeColumn(1);
		sheet.autoSizeColumn(2);
		sheet.autoSizeColumn(3);
	}
}